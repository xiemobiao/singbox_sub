<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hysteria2/Hy2 → Sing-box 转换器</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
    .container { max-width: 920px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 20px; margin: 0 0 14px; }
    .card { border: 1px solid rgba(127,127,127,.35); border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    textarea, input[type="text"], input[type="password"] { width: 100%; box-sizing: border-box; border: 1px solid rgba(127,127,127,.35); border-radius: 8px; padding: 10px; font: inherit; }
    textarea { min-height: 130px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row > div { min-width: 0; }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    button { appearance: none; border: 1px solid rgba(127,127,127,.35); background: transparent; padding: 8px 12px; border-radius: 8px; cursor: pointer; font: inherit; }
    button.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
    .muted { opacity: .8; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .result pre { white-space: pre-wrap; word-break: break-all; border: 1px solid rgba(127,127,127,.35); padding: 10px; border-radius: 8px; max-height: 260px; overflow: auto; }
    .grid { display: grid; gap: 8px; }
    .kv { display: grid; gap: 6px; grid-template-columns: 130px 1fr auto; align-items: center; }
    .copy { padding: 6px 10px; }
    .ok { color: #16a34a; }
    .err { color: #dc2626; }
    .hidden { display: none; }
  </style>
  <meta name="color-scheme" content="light dark" />
  <meta name="referrer" content="no-referrer" />
  <meta name="format-detection" content="telephone=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
</head>
<body>
  <div class="container">
    <h1>Hysteria2/Hy2 → Sing-box 转换器</h1>

    <div class="card">
      <label for="sub">输入 Hysteria2/Hy2 订阅（原始 URI、多行、整段 Base64、或远端 URL）</label>
      <textarea id="sub" placeholder="例如：
hy2://example.com:443?password=pw&sni=example.com#示例节点
或粘贴远端订阅 URL"></textarea>
      <div class="row" style="margin-top:10px">
        <div>
          <label for="apikey">API Key（可选，服务端启用鉴权时填写）</label>
          <input id="apikey" type="password" placeholder="Bearer Token" />
        </div>
        <div>
          <label for="alpn">默认 ALPN（可选，覆盖后端 DEFAULT_ALPN）</label>
          <input id="alpn" type="text" placeholder="例如：h3 或 h2,h3（当前仅示意，不覆盖）" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="preset">规则预设</label>
          <select id="preset" style="width:100%;padding:8px;border:1px solid rgba(127,127,127,.35);border-radius:8px;">
            <option value="">跟随服务端配置（默认）</option>
            <option value="cn_direct">国内直连（国外代理）</option>
            <option value="global_direct">全部直连</option>
            <option value="global_proxy">全部代理</option>
            <option value="proxy_domains_only">仅代理下方域名</option>
            <option value="direct_domains_only">仅直连下方域名</option>
          </select>
        </div>
        <div>
          <label>
            <input id="adblock" type="checkbox" /> 广告拦截（geosite:category-ads-all）
          </label>
          <div class="muted">需要客户端提供 geosite 数据库</div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>
            <input id="doh" type="checkbox" /> DoH 常见域名直连
          </label>
          <div class="muted">dns.google, cloudflare-dns.com 等</div>
        </div>
        <div>
          <label>
            <input id="strict" type="checkbox" /> 严格全局代理
          </label>
          <div class="muted">将 geosite:geolocation-!cn 显式走代理</div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label for="bypass">直连域名（逗号分隔）</label>
          <input id="bypass" type="text" placeholder="例如：example.cn,*.local" />
        </div>
        <div>
          <label for="proxyd">代理域名（逗号分隔）</label>
          <input id="proxyd" type="text" placeholder="例如：example.com,*.google.com" />
        </div>
      </div>
      <div class="btns">
        <button class="primary" id="btn-convert">转换</button>
        <button id="btn-clear">清空</button>
        <button id="btn-paste">从剪贴板粘贴</button>
      </div>
      <div id="msg" class="muted" style="margin-top:8px"></div>
    </div>

    <div id="panel-result" class="card hidden result">
      <div class="grid">
        <div class="kv">
          <div>节点数量</div>
          <div id="nodes-count" class="mono"></div>
          <div></div>
        </div>

        <div class="kv">
          <div>Base64 配置</div>
          <div>
            <pre id="b64" class="mono"></pre>
          </div>
          <div>
            <button class="copy" data-copy="#b64">复制</button>
          </div>
        </div>

        <div class="kv">
          <div>订阅 URL</div>
          <input id="url" class="mono" type="text" readonly />
          <div><button class="copy" data-copy="#url">复制</button></div>
        </div>

        <div class="kv">
          <div>短链</div>
          <input id="url-short" class="mono" type="text" readonly />
          <div><button class="copy" data-copy="#url-short">复制</button></div>
        </div>

        <div class="kv">
          <div>短链 JSON</div>
          <input id="url-short-json" class="mono" type="text" readonly />
          <div>
            <button class="copy" data-copy="#url-short-json">复制</button>
          </div>
        </div>

        <details>
          <summary>预览 JSON 配置</summary>
          <pre id="json-preview" class="mono"></pre>
        </details>
      </div>
    </div>

    <p class="muted">提示：默认每分钟 5 次转换；若服务端开启 API Key，请在上方输入。</p>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const msg = (text, cls = '') => { const m = document.querySelector('#msg'); m.textContent = text || ''; m.className = 'muted ' + cls; };

    async function copyFrom(selector) {
      const el = $(selector);
      const text = el?.value ?? el?.textContent ?? '';
      if (!text) return;
      try { await navigator.clipboard.writeText(text); msg('已复制到剪贴板', 'ok'); } catch { msg('复制失败，请手动复制', 'err'); }
    }

    async function pasteToTextarea() {
      try {
        const text = await navigator.clipboard.readText();
        document.querySelector('#sub').value = text || '';
      } catch { msg('无法读取剪贴板（需要权限）', 'err'); }
    }

    function buildHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const token = document.querySelector('#apikey').value.trim();
      if (token) headers['Authorization'] = 'Bearer ' + token;
      return headers;
    }

    async function previewJson(b64) {
      try {
        const resp = await fetch(`/subscription/${b64}?format=json`, { method: 'GET' });
        if (!resp.ok) return;
        const data = await resp.json();
        document.querySelector('#json-preview').textContent = JSON.stringify(data, null, 2);
      } catch(_) {}
    }

    async function convert() {
      const subscription = document.querySelector('#sub').value.trim();
      if (!subscription) { msg('请先输入订阅内容', 'err'); return; }
      msg('转换中...');

      try {
        const payload = { subscription };
        const preset = document.querySelector('#preset')?.value?.trim();
        if (preset) payload.rules_preset = preset;
        const adblock = document.querySelector('#adblock')?.checked;
        if (adblock) payload.enable_adblock = true;
        const doh = document.querySelector('#doh')?.checked;
        if (doh) payload.enable_doh_direct = true;
        const strict = document.querySelector('#strict')?.checked;
        if (strict) payload.strict_global_proxy = true;
        const bypass = document.querySelector('#bypass')?.value?.trim();
        if (bypass) payload.bypass_domains = bypass;
        const proxyd = document.querySelector('#proxyd')?.value?.trim();
        if (proxyd) payload.proxy_domains = proxyd;

        const resp = await fetch('/convert', {
          method: 'POST',
          headers: buildHeaders(),
          body: JSON.stringify(payload)
        });
        const text = await resp.text();
        let data = null;
        try { data = JSON.parse(text); } catch { throw new Error(text || '未知错误'); }
        if (!resp.ok) throw new Error(data?.detail || '请求失败');

        document.querySelector('#panel-result').classList.remove('hidden');
        document.querySelector('#nodes-count').textContent = data.nodes_count ?? '';
        document.querySelector('#b64').textContent = data.singbox_config ?? '';
        document.querySelector('#url').value = data.subscription_url ?? '';
        document.querySelector('#url-short').value = data.subscription_url_short ?? '';
        document.querySelector('#url-short-json').value = data.subscription_url_short_json ?? '';
        msg('转换成功', 'ok');

        await previewJson(data.singbox_config);
      } catch (e) {
        msg('转换失败：' + (e?.message || e), 'err');
      }
    }

    function syncPresetEffects() {
      const preset = document.querySelector('#preset')?.value?.trim();
      const bypass = document.querySelector('#bypass');
      const proxyd = document.querySelector('#proxyd');
      if (!bypass || !proxyd) return;
      bypass.disabled = false; proxyd.disabled = false;
      if (preset === 'proxy_domains_only') {
        bypass.disabled = true;
      } else if (preset === 'direct_domains_only') {
        proxyd.disabled = true;
      }
    }

    document.addEventListener('click', (ev) => {
      const t = ev.target;
      if (t.matches('.copy')) {
        const sel = t.getAttribute('data-copy');
        if (sel) copyFrom(sel);
      }
    });
    document.querySelector('#btn-convert').addEventListener('click', convert);
    document.querySelector('#btn-clear').addEventListener('click', () => { document.querySelector('#sub').value = ''; msg(''); });
    document.querySelector('#btn-paste').addEventListener('click', pasteToTextarea);
    document.querySelector('#preset')?.addEventListener('change', syncPresetEffects);
    syncPresetEffects();
  </script>
</body>
</html>
